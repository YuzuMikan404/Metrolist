name: Monitor Upstream Release and Build

on:
  workflow_dispatch:        # 手動実行用
  schedule:
    - cron: '0 * * * *'     # 1時間ごとにチェック

permissions:
  contents: write           # リリース作成とタグ打ちに必要

jobs:
  check_build_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. オリジナルの最新リリースタグを取得し、自分のリポジトリと比較
      - name: Check for new release
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UPSTREAM_TAG=$(gh api repos/mostafaalagamy/Metrolist/releases/latest --jq .tag_name)
          echo "Upstream latest tag: $UPSTREAM_TAG"
          
          if git rev-parse "$UPSTREAM_TAG" >/dev/null 2>&1; then
            echo "Tag $UPSTREAM_TAG already exists. Skipping build."
            echo "trigger_build=false" >> $GITHUB_OUTPUT
          else
            echo "New version found: $UPSTREAM_TAG. Proceeding with build."
            echo "trigger_build=true" >> $GITHUB_OUTPUT
            echo "release_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          fi

      # 2. コードの取得
      - name: Fetch Upstream Source
        if: steps.check.outputs.trigger_build == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git remote add upstream https://github.com/mostafaalagamy/Metrolist.git
          git fetch upstream --tags
          git checkout -b build-${{ steps.check.outputs.release_tag }} refs/tags/${{ steps.check.outputs.release_tag }}

      # 3. Java 21 セットアップ
      - name: Set up JDK 21
        if: steps.check.outputs.trigger_build == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Gradleセットアップ
      - name: Setup Gradle
        if: steps.check.outputs.trigger_build == 'true'
        uses: gradle/actions/setup-gradle@v4

      # 4. クローン化処理（ここを修正：フォルダ移動を追加）
      - name: Modify for Clone
        if: steps.check.outputs.trigger_build == 'true'
        run: |
          echo "Applying clone modifications..."

          # --- [追加修正] データベース定義フォルダの移動 ---
          # コード内のパッケージ名を music -> clone に変えると、Roomはこのフォルダを探しに行きます。
          # そのため、フォルダもリネーム（コピー）してあげる必要があります。
          if [ -d "app/schemas/com.metrolist.music.db.InternalDatabase" ]; then
            echo "Migrating Room schemas..."
            mkdir -p app/schemas/com.metrolist.clone.db.InternalDatabase
            cp -r app/schemas/com.metrolist.music.db.InternalDatabase/* app/schemas/com.metrolist.clone.db.InternalDatabase/
          fi
          # ----------------------------------------------

          # 1. パッケージ名(ID)の書き換え
          find . -name "build.gradle.kts" -print0 | xargs -0 sed -i 's/com.metrolist.music/com.metrolist.clone/g'
          find . -name "build.gradle" -print0 | xargs -0 sed -i 's/com.metrolist.music/com.metrolist.clone/g'
          
          # 2. ソースコード内のパッケージ書き換え
          find app/src/main -type f -name "*.kt" -print0 | xargs -0 sed -i 's/com.metrolist.music/com.metrolist.clone/g'
          find app/src/main -type f -name "*.xml" -print0 | xargs -0 sed -i 's/com.metrolist.music/com.metrolist.clone/g'

          # 3. アプリ名の変更
          sed -i 's/>Metrolist</>Metrolist Clone</g' app/src/main/res/values/strings.xml

          # 4. 署名設定の無効化（エラー回避）
          find . -name "build.gradle.kts" -print0 | xargs -0 sed -i 's/signingConfig =/\/\/ signingConfig =/g'

          echo "Modification complete."

      - name: Grant execute permission for gradlew
        if: steps.check.outputs.trigger_build == 'true'
        run: chmod +x gradlew

      # 5. ビルド実行
      - name: Build Release APK
        if: steps.check.outputs.trigger_build == 'true'
        # エラーが出やすいチェック(lint)とテスト(test)はスキップ
        run: ./gradlew assembleRelease -x lint -x test --stacktrace
        env:
          LASTFM_API_KEY: "dummy_value"
          LASTFM_SECRET: "dummy_value"

      # 6. APK署名
      - name: Sign APK
        if: steps.check.outputs.trigger_build == 'true'
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: "34.0.0"

      # 7. リリース作成
      - name: Create Release
        if: steps.check.outputs.trigger_build == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.check.outputs.release_tag }}
          name: Clone v${{ steps.check.outputs.release_tag }}
          body: |
            Automated clone build based on upstream version ${{ steps.check.outputs.release_tag }}.
            Package Name: `com.metrolist.clone`
            Original: https://github.com/mostafaalagamy/Metrolist/releases/tag/${{ steps.check.outputs.release_tag }}
          files: ${{ steps.sign_app.outputs.signedReleaseFile }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
