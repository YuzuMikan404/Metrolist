name: Build Metrolist Neo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. 初期化
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 環境構築 (Java 17固定)
      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - uses: gradle/actions/setup-gradle@v4

      # 3. 更新チェック & クリーンアップ
      - name: Check & Setup
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh api repos/mostafaalagamy/Metrolist/releases/latest --jq .tag_name)
          echo "Target: $TAG"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            gh release delete "$TAG" --yes --cleanup-tag || true
            git push --delete origin "$TAG" || true
            echo "trigger=true" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          elif ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "trigger=true" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            echo "trigger=false" >> $GITHUB_OUTPUT
          fi

      # 4. ソース取得
      - name: Fetch Source
        if: steps.check.outputs.trigger == 'true'
        run: |
          git config user.name "Action"
          git config user.email "action@github.com"
          [ -f icon.png ] && cp icon.png /tmp/icon.png
          git remote add upstream https://github.com/mostafaalagamy/Metrolist.git
          git fetch upstream --tags
          git checkout -b build-${{ steps.check.outputs.tag }} refs/tags/${{ steps.check.outputs.tag }}
          [ -f /tmp/icon.png ] && mv /tmp/icon.png icon.png

      # 5. アイコン処理 (画像生成のみPythonで行う)
      - name: Process Icon
        if: steps.check.outputs.trigger == 'true'
        run: |
          if [ ! -f icon.png ]; then
            echo "WARNING: icon.png not found"
            exit 0
          fi

          pip install Pillow
          python -c "
          from PIL import Image, ImageOps
          try:
              img = Image.open('icon.png').convert('RGBA')
              # 色抽出
              p = img.resize((1, 1)).getpixel((0, 0))
              bg = '#{:02x}{:02x}{:02x}'.format(*p[:3]) if p[3] > 0 else '#000000'
              with open('bg_color.txt', 'w') as f: f.write(bg)
              
              # 前景 (70%)
              size = 1080
              t = int(size * 0.70)
              canvas = Image.new('RGBA', (size, size), (0, 0, 0, 0))
              r = ImageOps.fit(img, (t, t), centering=(0.5, 0.5))
              o = (size - t) // 2
              canvas.paste(r, (o, o), r)
              canvas.save('fg.png')
              img.save('legacy.png')
          except: pass
          "
          
          # ファイル配置 (シェルコマンドで確実に実行)
          # 既存のic_launcher削除 (tv_bannerは消えない)
          find app/src/main/res -name "ic_launcher*" -delete
          
          # フォルダ作成
          mkdir -p app/src/main/res/mipmap-anydpi-v26
          mkdir -p app/src/main/res/mipmap-xxxhdpi
          mkdir -p app/src/main/res/values

          # XML生成
          BG=$(cat bg_color.txt)
          XML='<?xml version="1.0" encoding="utf-8"?><adaptive-icon xmlns:android="http://schemas.android.com/apk/res/android"><background android:drawable="@color/ic_launcher_background"/><foreground android:drawable="@mipmap/ic_launcher_foreground"/></adaptive-icon>'
          echo "$XML" > app/src/main/res/mipmap-anydpi-v26/ic_launcher.xml
          echo "$XML" > app/src/main/res/mipmap-anydpi-v26/ic_launcher_round.xml
          
          # 色定義
          echo "<?xml version=\"1.0\" encoding=\"utf-8\"?><resources><color name=\"ic_launcher_background\">$BG</color></resources>" > app/src/main/res/values/ic_launcher_background.xml
          
          # 画像移動
          mv fg.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_foreground.png
          cp legacy.png app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          mv legacy.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png
          echo "Icons replaced."

      # 6. テキストファイルの書き換え (sedを使用・シンプル化)
      - name: Modify Files
        if: steps.check.outputs.trigger == 'true'
        run: |
          # ダミーJSON
          echo '{"project_info":{"project_number":"0","project_id":"d"},"client":[{"client_info":{"mobilesdk_app_id":"1:0:a:0","android_client_info":{"package_name":"com.metrolist.clone"}},"api_key":[{"current_key":"d"}]}]}' > app/google-services.json

          # Gradle (ID変更)
          sed -i 's/applicationId = "com.metrolist.music"/applicationId = "com.metrolist.clone"/g' app/build.gradle.kts
          # Gradle (プラグイン無効化)
          sed -i 's/alias(libs.plugins.google.services)/\/\/ alias/g' app/build.gradle.kts
          sed -i 's/id("com.google.gms.google-services")/\/\/ id/g' app/build.gradle.kts
          
          # Gradle (設定注入: Kotlin DSLの正しい記法で追記)
          # sedで置換するより、末尾に追記するほうが壊れにくい
          # defaultConfigブロックの中に追記するのは難しいので、単純な置換を行う
          sed -i 's/defaultConfig {/defaultConfig { resValue("string", "app_name", "Metrolist Neo"); resValue("color", "ic_launcher_background_force", "#000000");/g' app/build.gradle.kts

          # Manifest (参照先変更)
          # どんな記述があろうと、app_nameとアイコンへの参照を強制的に書き換える
          sed -i 's/android:label="[^"]*"/android:label="@string\/app_name"/g' app/src/main/AndroidManifest.xml
          sed -i 's/android:icon="[^"]*"/android:icon="@mipmap\/ic_launcher"/g' app/src/main/AndroidManifest.xml
          
          # roundIcon があれば書き換え、なければ application タグに追加
          if grep -q "android:roundIcon" app/src/main/AndroidManifest.xml; then
            sed -i 's/android:roundIcon="[^"]*"/android:roundIcon="@mipmap\/ic_launcher_round"/g' app/src/main/AndroidManifest.xml
          else
            sed -i 's/<application/<application android:roundIcon="@mipmap\/ic_launcher_round"/g' app/src/main/AndroidManifest.xml
          fi
          
          echo "Files modified."

      - name: Grant Permission
        if: steps.check.outputs.trigger == 'true'
        run: chmod +x gradlew

      # 7. ビルド
      - name: Build
        if: steps.check.outputs.trigger == 'true'
        run: ./gradlew assembleRelease --no-configuration-cache -x lint -x test -Dorg.gradle.daemon=false
        env:
          GITHUB_EVENT_NAME: pull_request
          LASTFM_API_KEY: "dummy"
          LASTFM_SECRET: "dummy"

      # 8. 回収・署名
      - name: Collect and Sign
        if: steps.check.outputs.trigger == 'true'
        uses: ilharp/sign-android-release@v1
        with:
          releaseDir: app/build/outputs/apk/release
          signingKey: ${{ secrets.SIGNING_KEY }}
          keyAlias: ${{ secrets.ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
          buildToolsVersion: "34.0.0"

      # 9. リリース
      - name: Create Release
        if: steps.check.outputs.trigger == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.check.outputs.tag }}
          name: ${{ steps.check.outputs.tag }}
          body: |
            Original: https://github.com/mostafaalagamy/Metrolist/releases/tag/${{ steps.check.outputs.tag }}
          files: app/build/outputs/apk/release/*-signed.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
